name: Terraform AWS VPN Site-to-Site Module
#logo: logo/logo.jpg

license: "APACHE2"

copyrights:
  - name: "Cloud Ops Works LLC"
    url: "https://cloudops.works"
    year: "2024"

github_repo: cloudopsworks/terraform-module-aws-vpn-site-to-site

description: |-
  Enterprise-grade AWS VPN Site-to-Site module for establishing high-availability encrypted connections. Supports both Transit Gateway (TGW) and Virtual Private Gateway (VGW) attachments, provides automated CloudWatch logging, comprehensive monitoring with health alarms, and flexible routing options including BGP and static routes.

# Introduction to the project
introduction: |-
  The AWS VPN Site-to-Site module simplifies the deployment of secure tunnels between on-premises networks and AWS. Designed with flexibility in mind, it allows for granular control over tunnel specifications such as IKE versions, encryption protocols, and DPD actions. It integrates seamlessly with AWS's networking ecosystem, offering native support for route propagation and centralized TGW management, ensuring your hybrid cloud connectivity is both robust and observable.

# How to use this project
usage: |-
  Deploying the VPN module is best achieved using Terragrunt, which facilitates clear configuration and multi-environment management.

  ### Module Variables Structure

  The following variables define the module's behavior. They should be placed within the `inputs` block of your `terragrunt.hcl`.

  - `org`: (Required) **object** - Organizational metadata used for standard naming and tagging conventions.
    - `organization_name`: (Required) Name of the organization.
    - `organization_unit`: (Required) Department or business unit.
    - `environment_type`: (Required) Type of environment (e.g., prod, non-prod).
    - `environment_name`: (Required) Specific name of the environment.
  - `name`: (Optional) **string** - The primary name for the VPN connection. Defaults to "".
  - `name_prefix`: (Optional) **string** - A prefix applied to all generated resource names.
  - `is_hub`: (Optional) **bool** - Set to `true` if this VPN is part of a HUB architecture. Defaults to `false`.
  - `spoke_def`: (Optional) **string** - Identifier for the spoke if applicable. Defaults to "001".
  - `extra_tags`: (Optional) **map(string)** - Additional tags to be merged with the standard organizational tags.
  - `vpc`: (Optional) **any** - Configuration for the VPC where the VPN or VGW resides.
    - `vpc_id`: (Required if vpc provided) The AWS ID of the target VPC.
    - `route_table_ids`: (Optional) List of Route Table IDs for enabling route propagation.
  - `settings`: (Optional) **any** - The central configuration object for the VPN tunnels, gateways, and monitoring.

  ### Complete Configuration (YAML Format)

  The following YAML represents the full capability of the module. You can use this as a reference to build your Terragrunt `inputs`:

  ```yaml
  # Top-level variables
  org:
    organization_name: "cloudopsworks" # (Required)
    organization_unit: "platform"      # (Required)
    environment_type: "prod"           # (Required)
    environment_name: "us-east-1"      # (Required)
  
  name: "corp-connect"                 # (Optional)
  name_prefix: "primary"               # (Optional)
  is_hub: false                        # (Optional)
  spoke_def: "001"                     # (Optional)
  extra_tags:                          # (Optional)
    Team: "Network"
  
  vpc:                                 # (Optional) Required for VGW
    vpc_id: "vpc-0a1b2c3d4e5f"         # (Required)
    route_table_ids: ["rtb-112233"]    # (Optional)

  # Deep settings
  settings:
    type: "ipsec.1"                    # (Optional) default: ipsec.1
    transit_gateway_id: "tgw-xyz..."   # (Optional) Attachment for TGW
    static_routes_only: true           # (Optional)
    enable_acceleration: false         # (Optional)
    outside_ip_address_type: PublicIpv4 # (Optional) PublicIpv4 | PrivateIpv4
    tunnel_inside_ip_version: ipv4     # (Optional) ipv4 | ipv6

    alarms:
      enabled: true                    # (Optional) Enable health alarms
      priority: 1                      # (Optional) 1=P1, 2=P2
      for_each_tunnel: true            # (Optional) Separate alarm per tunnel
      sns_topics: ["notifications"]    # (Optional)
      sns_topic_arns: []               # (Optional)
      threshold: 1                     # (Optional) default: 1

    customer_gateway:
      enabled: true                    # (Optional)
      ip_address: "203.0.113.1"        # (Required)
      bgp_asn: 65000                   # (Optional)
      device_name: "onprem-router"     # (Optional)
      certificate_arn: null            # (Optional)
      id: "cgw-existing"               # (Optional) if enabled: false

    vpn_gateway:
      enabled: false                   # (Optional)
      id: "vgw-existing"               # (Optional) if enabled: false
      amazon_side_asn: 64512           # (Optional)
      propagation:
        enabled: true                  # (Optional) Enable VGW propagation

    local:
      ipv4_network_cidr: "10.0.0.0/16" # (Optional)
    remote:
      ipv4_network_cidr: "172.16.0.0/12" # (Optional)

    routes:                            # (Optional) Static routes list
      - destination_cidr_block: "192.168.0.0/24"

    tunnel1:                           # (Optional) Advanced Tunnel 1
      inside_cidr: "169.254.10.0/30"
      preshared_key: "strongkey123"
      dpd_timeout_action: restart      # (Optional) clear | none | restart
      ike_versions: ["ikev2"]          # (Optional)
      log:
        enabled: true
        retention_in_days: 14
      phase1:
        encryption_algorithms: ["aes256"]
        integrity_algorithms: ["sha256"]
        dh_group_numbers: [14]
      phase2:
        encryption_algorithms: ["aes256"]
        integrity_algorithms: ["sha256"]
        dh_group_numbers: [14]
    
    tunnel2:                           # (Optional) Advanced Tunnel 2
      # ... same as tunnel1
  ```

# Example usage
examples: |-
  ### Terragrunt: VPN with Transit Gateway and Alarms
  
  ```hcl
  terraform {
    source = "git::https://github.com/cloudopsworks/terraform-module-aws-vpn-site-to-site.git?ref=v1.0.0"
  }

  include "root" {
    path = find_in_parent_folders()
  }

  inputs = {
    org = {
      organization_name = "acme"
      organization_unit = "it"
      environment_type  = "prod"
      environment_name  = "global"
    }
    
    name = "main-office"
    
    settings = {
      transit_gateway_id = "tgw-0aabbcc112233"
      customer_gateway = {
        ip_address = "1.2.3.4"
        bgp_asn    = 65100
      }
      alarms = {
        enabled    = true
        sns_topics = ["infrastructure-alerts"]
      }
    }
  }
  ```

  ### Terragrunt: VPN with Virtual Private Gateway
  
  ```hcl
  terraform {
    source = "git::https://github.com/cloudopsworks/terraform-module-aws-vpn-site-to-site.git?ref=v1.1.0"
  }

  inputs = {
    org = {
      organization_name = "acme"
      organization_unit = "it"
      environment_type  = "dev"
      environment_name  = "us-east-1"
    }

    vpc = {
      vpc_id          = "vpc-88776655"
      route_table_ids = ["rtb-aabbcc"]
    }

    settings = {
      vpn_gateway = {
        enabled     = true
        propagation = { enabled = true }
      }
      customer_gateway = {
        ip_address = "5.6.7.8"
      }
      static_routes_only = true
      routes = [
        { destination_cidr_block = "10.20.0.0/16" }
      ]
    }
  }
  ```

# How to get started quickly
quickstart: |-
  1. **Identify Connection Parameters**: Obtain your on-premises public IP address and decided on BGP vs Static routing.
  2. **Set up Terragrunt**: Create a `terragrunt.hcl` in your desired environment folder.
  3. **Provide Inputs**: Fill in the `org` object and `settings.customer_gateway.ip_address`.
  4. **Deploy**: Run the following commands:
     ```bash
     terragrunt init
     terragrunt apply
     ```
  5. **Verify Connection**: Once applied, check the AWS Console under VPC > Site-to-Site VPN Connections to verify the tunnel status and download the configuration for your on-premises device.

include:
  - "docs/targets.md"
  - "docs/terraform.md"

contributors:
  - name: "Cristian Beraha"
    github: "berahac"